---
phase: 3
plan: 3.1
wave: 3
---

# Plan 3.1: Dashboard Analytics & Stats

## Objective
Implement MongoDB aggregation pipelines to calculate dynamic statistics for the Dashboard summary cards across all User roles (Admin, Manager, Agent), replacing existing static data. This fulfills REQ-07.

## Context
Load these files for context:
- .gsd/SPEC.md
- .gsd/REQUIREMENTS.md
- src/pages/admin/AdminDashboard.tsx
- src/pages/manager/ManagerDashboard.tsx
- src/pages/agent/AgentDashboard.tsx

## Tasks

<task type="auto">
  <name>Create Analytics API Endpoint</name>
  <files>
    api/analytics/index.ts
  </files>
  <action>
    Create a new serverless function for `GET /api/analytics`.
    Authenticate user via JWT middleware and branch logic based on `req.user.role`.
    - Admin: Count total leads, active agents, total value, and conversion rate across the whole system.
    - Manager: Limit metrics to leads and agents under their purview.
    - Agent: Limit metrics to their assigned leads.
    Return JSON payload with aggregated metrics.
  </action>
  <verify>curl -X GET localhost:3000/api/analytics -H "Authorization: Bearer <token>"</verify>
  <done>Returns dynamic dashboard statistics like `{ totalLeads: 45, conversionRate: 12.5, ... }`</done>
</task>

<task type="auto">
  <name>Integrate Frontend Dashboard Metrics</name>
  <files>
    src/lib/api.ts
    src/pages/admin/AdminDashboard.tsx
    src/pages/manager/ManagerDashboard.tsx
    src/pages/agent/AgentDashboard.tsx
  </files>
  <action>
    - Add `fetchAnalytics()` wrapper in `src/lib/api.ts`.
    - Use `useQuery` to fetch analytics on dashboard pages.
    - Replace the `<CardContent>` hardcoded values in each dashboard component with the live payload data.
    - Handle loading and error states gracefully.
  </action>
  <verify>Verify no errors in the build and metrics render dynamically.</verify>
  <done>Mock statistics are completely replaced by dynamic API responses for all three dashboard views.</done>
</task>

## Success Criteria
- [ ] No static metrics utilized in any Dashboard views.
- [ ] Role-based stats accurate depending on logged-in user.
- [ ] Aggregation pipelines handle counts securely.
