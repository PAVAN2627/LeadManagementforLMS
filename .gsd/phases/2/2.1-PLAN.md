---
phase: 2
plan: 2.1
wave: 1
---

# Plan 2.1: Lead Model & CRUD

## Objective
Implement the `Lead` Mongoose model and creating CRUD (Create, Read, Update, Delete) API endpoints. This allows leads to be managed dynamically in the database instead of using `mockData.ts`.

## Context
- .gsd/SPEC.md (Goal 3: Data Persistence)
- src/components/tables/LeadsTable.tsx (Frontend Lead Type)
- src/data/mockData.ts (Mock Data Structure)

## Tasks

<task type="auto">
  <name>Create Lead Model</name>
  <files>src/models/Lead.ts</files>
  <action>
    Create Mongoose `Lead` model matching frontend `Lead` interface + database needs:
    - `name`, `email`, `phone`, `company`, `source` (all string)
    - `status` (enum: new, contacted, qualified, proposal, negotiation, converted, lost)
    - `assignedAgent` (string - storing agent name/ID? Better to store Agent ID reference `assignedAgentId` and virtual populate, but for now store Name or stick to ID if we have User model. Let's store `assignedAgentId` as ObjectId ref to User, but for compatibility with frontend that expects string name, we might need populate. Actually, let's update frontend to handle populated object or plain string. For MVP, let's keep it simple: `assignedAgent` as ObjectId ref to `User` model.)
    - `date` (Date, default now)
    - `nextFollowUp` (Date, optional)
    - `notes` (string/array of objects? Requirement says "notes". Let's use array of subdocuments for future proofing or simple string for now. Let's stick to array of objects `{ text: string, date: Date, author: string }` if possible, or simple string field if prototype demands. Looking at `mockData.ts` notes are in activities. Let's keep `notes` simple or separate.)
    - Timestamps (createdAt, updatedAt)
  </action>
  <verify>test -f src/models/Lead.ts</verify>
  <done>Lead model defined with correct schema.</done>
</task>

<task type="auto">
  <name>Create Lead API</name>
  <files>api/leads/index.ts, api/leads/[id].ts</files>
  <action>
    Create Vercel functions for lead management.
    
    `api/leads/index.ts`:
    - GET: Fetch all leads (support query params?)
      - Admin: All leads
      - Manager: Team leads (if team logic exists, else all)
      - Agent: Only assigned leads
    - POST: Create new lead
    
    `api/leads/[id].ts`:
    - GET: Fetch single lead
    - PUT: Update lead (status, notes, etc.)
    - DELETE: Remove lead (Admin only?)
    
    *Security*: All endpoints must verify JWT (`verifyToken`).
  </action>
  <verify>test -f api/leads/index.ts</verify>
  <done>CRUD endpoints for leads created.</done>
</task>

## Success Criteria
- [ ] Lead model matches frontend expectations (or frontend adapted).
- [ ] API directs requests based on HTTP method.
- [ ] Role-based filtering implemented (Agents see own leads).
