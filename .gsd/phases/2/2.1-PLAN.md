---
phase: 2
plan: 2.1
wave: 1
---

# Plan 2.1: Lead Model & CRUD

## Objective
Implement the `Lead` Mongoose model and creating CRUD (Create, Read, Update, Delete) API endpoints. This allows leads to be managed dynamically in the database instead of using `mockData.ts`.

## Context
- .gsd/SPEC.md (Goal 3: Data Persistence)
- src/components/tables/LeadsTable.tsx (Frontend Lead Type)
- src/data/mockData.ts (Mock Data Structure)

## Tasks

<task type="auto">
  <name>Create Lead Model</name>
  <files>src/models/Lead.ts</files>
  <action>
    Create Mongoose `Lead` model matching database needs:
    - `name`, `email`, `phone`, `company`, `source` (all string)
    - `status` (enum: "new", "contacted", "qualified", "proposal", "negotiation", "converted", "lost")
    - `assignedTo` (ObjectId ref to `User` model, required)
    - `date` (Date, default now)
    - `nextFollowUp` (Date, optional)
    - Timestamps (createdAt, updatedAt)
  </action>
  <verify>test -f src/models/Lead.ts</verify>
  <done>Lead model defined with correct schema.</done>
</task>

<task type="auto">
  <name>Create Note Model</name>
  <files>src/models/Note.ts</files>
  <action>
    Create Mongoose `Note` model:
    - `content` (string, required)
    - `lead` (ObjectId ref to `Lead`, required)
    - `author` (ObjectId ref to `User`, required)
    - Timestamps (createdAt, updatedAt)
  </action>
  <verify>test -f src/models/Note.ts</verify>
  <done>Note model defined.</done>
</task>

<task type="auto">
  <name>Create Lead API</name>
  <files>api/leads/index.ts, api/leads/[id].ts</files>
  <action>
    Create Vercel functions for lead management.
    
    `api/leads/index.ts`:
    - GET: Fetch all leads (support query params?)
      - Admin: All leads
      - Manager: Team leads (if team logic exists, else all)
      - Agent: Only assigned leads
      - *Populate `assignedTo` field*
    - POST: Create new lead
    
    `api/leads/[id].ts`:
    - GET: Fetch single lead (populate `assignedTo`)
    - PUT: Update lead (status, etc.)
    - DELETE: Remove lead (Admin only?)
    
    *Security*: All endpoints must verify JWT (`verifyToken`).
  </action>
  <verify>test -f api/leads/index.ts</verify>
  <done>CRUD endpoints for leads created.</done>
</task>

## Success Criteria
- [ ] Lead model matches frontend expectations (or frontend adapted).
- [ ] API directs requests based on HTTP method.
- [ ] Role-based filtering implemented (Agents see own leads).
